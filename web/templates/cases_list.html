{% extends "base.html" %}
{% load i18n static %}
{% get_current_language as LANGUAGE_CODE %}

{% block title %}Datalization – {% trans "Case Studies" %}{% endblock %}

{% block content %}
<div class="min-h-screen bg-background text-foreground cases-page">
  <!-- Hero -->
  <section class="cases-hero scroll-mt-20">
    <div class="container mx-auto px-4 text-center">
      <h1>Case Studies</h1>
      <p class="cases-subtext">
        {% if LANGUAGE_CODE == 'de' %}
          Erfolgsgeschichten unserer Kunden – von der Herausforderung zur Lösung
        {% else %}
          Success stories of our clients – from challenge to solution
        {% endif %}
      </p>
      <p class="cases-subtext-muted">
        {% if LANGUAGE_CODE == 'de' %}
          Erfahren Sie, wie wir Unternehmen bei ihrer digitalen Transformation unterstützen und messbare Erfolge erzielen.
        {% else %}
          See how we support companies in their digital transformation and achieve measurable results.
        {% endif %}
      </p>

    </div>
  </section>

  <!-- Case List -->
  <section class="cases-list-section">
    <div class="container mx-auto px-4">
      <div class="cases-list-grid">
        {% for c in cases %}
          <article
            class="case-feature-card"
            id="case-{{ c.slug }}"
            role="button"
            tabindex="0"
            data-case-title="{{ c.title|escape }}"
            data-case-client="{{ c.client_brief|default:''|escape }}"
            data-case-summary="{{ c.summary|default:''|escape }}"
            data-case-problem="{{ c.problem_brief|default:''|escape }}"
            data-case-results="{{ c.result_list|join:'||'|default:''|escape }}"
            data-case-category="{{ c.category|default:''|escape }}"
            data-case-image="{% if c.image %}{{ c.image.url }}{% endif %}"
            data-case-tech="{{ c.tech_stack|default:''|escape }}"
          >
            <div class="case-feature-media">
              {% if c.category %}
                <span class="case-feature-badge">{{ c.category }}</span>
              {% endif %}
              {% if c.image %}
                <img src="{{ c.image.url }}" alt="{{ c.title }}" loading="lazy" class="case-feature-img">
              {% else %}
                <div class="case-feature-placeholder">D</div>
              {% endif %}
            </div>
            <div class="case-feature-content">
              <h3>{{ c.title }}</h3>
              {% if c.client_brief %}
                <p class="case-feature-meta">{{ c.client_brief }}</p>
              {% endif %}
              {% with summary_text=c.summary|default:c.problem_brief %}
                {% if summary_text %}
                  <p class="case-feature-summary">{{ summary_text|truncatechars:220 }}</p>
                {% endif %}
              {% endwith %}

              {% if c.problem_brief %}
                <div class="case-feature-section">
                  <div class="case-feature-label">{% if LANGUAGE_CODE == 'de' %}Herausforderung{% else %}Challenge{% endif %}</div>
                  <p>{{ c.problem_brief|truncatechars:220 }}</p>
                </div>
              {% endif %}

              {% if c.summary %}
                <div class="case-feature-section">
                  <div class="case-feature-label">{% if LANGUAGE_CODE == 'de' %}Lösung{% else %}Solution{% endif %}</div>
                  <p>{{ c.summary|truncatechars:220 }}</p>
                </div>
              {% endif %}

              {% if c.result_list %}
                <div class="case-feature-section">
                  <div class="case-feature-label">{% if LANGUAGE_CODE == 'de' %}Ergebnisse{% else %}Results{% endif %}</div>
                  <ul class="case-feature-results">
                    {% for item in c.result_list %}
                      <li><span class="case-result-icon">✔</span>{{ item|truncatechars:120 }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </div>
          </article>
        {% empty %}
          <p class="text-muted text-center py-10">
            {% if LANGUAGE_CODE == 'de' %}
              Noch keine Case Studies veröffentlicht.
            {% else %}
              No case studies published yet.
            {% endif %}
          </p>
        {% endfor %}
      </div>
    </div>
  </section>
</div>

<!-- Case Modal -->
<div class="case-modal" id="case-modal" hidden>
  <div class="case-modal__backdrop"></div>
  <div class="case-modal__dialog">
    <button class="case-modal__close" id="case-modal-close" aria-label="Close">×</button>
    <div class="case-modal__media">
      <span class="case-feature-badge" id="case-modal-badge" hidden></span>
      <img id="case-modal-img" alt="">
    </div>
    <div class="case-modal__body">
      <h3 id="case-modal-title"></h3>
      <p class="case-feature-meta" id="case-modal-client"></p>
      <p class="case-feature-summary" id="case-modal-summary"></p>

      <div class="case-feature-section" id="modal-problem" hidden>
        <div class="case-feature-label">{% if LANGUAGE_CODE == 'de' %}Herausforderung{% else %}Challenge{% endif %}</div>
        <p></p>
      </div>

      <div class="case-feature-section" id="modal-solution" hidden>
        <div class="case-feature-label">{% if LANGUAGE_CODE == 'de' %}Lösung{% else %}Solution{% endif %}</div>
        <p></p>
      </div>

      <div class="case-feature-section" id="modal-results" hidden>
        <div class="case-feature-label">{% if LANGUAGE_CODE == 'de' %}Ergebnisse{% else %}Results{% endif %}</div>
        <ul class="case-feature-results"></ul>
      </div>

      <div class="case-feature-section" id="modal-tech" hidden>
        <div class="case-feature-label">{% if LANGUAGE_CODE == 'de' %}Technologien{% else %}Technologies{% endif %}</div>
        <div class="case-feature-tags"></div>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    const modal = document.getElementById('case-modal');
    const closeBtn = document.getElementById('case-modal-close');
    const imgEl = document.getElementById('case-modal-img');
    const badgeEl = document.getElementById('case-modal-badge');
    const titleEl = document.getElementById('case-modal-title');
    const clientEl = document.getElementById('case-modal-client');
    const summaryEl = document.getElementById('case-modal-summary');
    const problemWrap = document.getElementById('modal-problem');
    const solutionWrap = document.getElementById('modal-solution');
    const resultsWrap = document.getElementById('modal-results');
    const techWrap = document.getElementById('modal-tech');

    function openModal(data){
      titleEl.textContent = data.title || '';
      clientEl.textContent = data.client || '';
      summaryEl.textContent = data.summary || '';

      if (data.image) {
        imgEl.src = data.image;
        imgEl.alt = data.title || '';
      } else {
        imgEl.src = '';
        imgEl.alt = '';
      }

      if (data.category) {
        badgeEl.hidden = false;
        badgeEl.textContent = data.category;
      } else {
        badgeEl.hidden = true;
      }

      if (data.problem) {
        problemWrap.hidden = false;
        problemWrap.querySelector('p').textContent = data.problem;
      } else {
        problemWrap.hidden = true;
      }

      if (data.solution) {
        solutionWrap.hidden = false;
        solutionWrap.querySelector('p').textContent = data.solution;
      } else {
        solutionWrap.hidden = true;
      }

      const resultsList = resultsWrap.querySelector('ul');
      resultsList.innerHTML = '';
      if (data.results && data.results.length) {
        resultsWrap.hidden = false;
        data.results.forEach(item=>{
          const li = document.createElement('li');
          const icon = document.createElement('span');
          icon.className = 'case-result-icon';
          icon.textContent = '✔';
          li.appendChild(icon);
          li.appendChild(document.createTextNode(item));
          resultsList.appendChild(li);
        });
      } else {
        resultsWrap.hidden = true;
      }

      const techList = techWrap.querySelector('.case-feature-tags');
      techList.innerHTML = '';
      if (data.tech && data.tech.length) {
        techWrap.hidden = false;
        data.tech.forEach(tag=>{
          const span = document.createElement('span');
          span.className = 'case-tech-tag';
          span.textContent = tag;
          techList.appendChild(span);
        });
      } else {
        techWrap.hidden = true;
      }

      modal.hidden = false;
      document.body.classList.add('modal-open');
    }

    function closeModal(){
      modal.hidden = true;
      document.body.classList.remove('modal-open');
    }

    document.querySelectorAll('.case-feature-card').forEach(card=>{
      card.addEventListener('click', ()=>{
        const resRaw = card.dataset.caseResults || '';
        const resArr = resRaw ? resRaw.split('||').filter(Boolean) : [];
        const techRaw = card.dataset.caseTech || '';
        const techArr = techRaw ? techRaw.split(',').map(t=>t.trim()).filter(Boolean) : [];
        openModal({
          title: card.dataset.caseTitle || '',
          client: card.dataset.caseClient || '',
          summary: card.dataset.caseSummary || '',
          problem: card.dataset.caseProblem || '',
          solution: card.dataset.caseSummary || '',
          results: resArr,
          category: card.dataset.caseCategory || '',
          image: card.dataset.caseImage || '',
          tech: techArr
        });
      });
      card.addEventListener('keypress',(e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); card.click(); } });
    });

    closeBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click',(e)=>{ if(e.target === modal || e.target.classList.contains('case-modal__backdrop')) closeModal(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && !modal.hidden) closeModal(); });
  })();
</script>
{% endblock %}
</div>
